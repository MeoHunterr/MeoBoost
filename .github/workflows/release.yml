name: Release and Deploy

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # Create GitHub Release (only on tags)
  release:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create source ZIP
        run: |
          # Create a clean source archive
          zip -r MeoBoost-source.zip . \
            -x ".git/*" \
            -x ".github/*" \
            -x "__pycache__/*" \
            -x "*.pyc" \
            -x ".venv/*" \
            -x "dist/*" \
            -x "build/*"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: MeoBoost ${{ github.ref_name }}
          body: |
            ## üöÄ MeoBoost ${{ github.ref_name }}
            
            ### ‚ö° Quick Start (One-Liner)
            
            Run in PowerShell as Administrator:
            ```powershell
            irm https://raw.githubusercontent.com/${{ github.repository }}/main/run.ps1 | iex
            ```
            
            This command will:
            1. ‚úÖ Install Python automatically if not found
            2. ‚úÖ Download the latest source code
            3. ‚úÖ Install dependencies
            4. ‚úÖ Run MeoBoost with admin privileges
            
            ### üõ°Ô∏è Security - Zero AV Detections
            
            MeoBoost runs directly from Python source code - no compiled EXE files.
            This ensures:
            - **100% Transparency** - All code is visible and auditable
            - **Zero AV False Positives** - No binaries to trigger antivirus
            - **Always Up-to-Date** - One-liner always gets the latest version
            
            ### üì¶ Manual Installation
            
            ```bash
            git clone https://github.com/${{ github.repository }}.git
            cd meoboost
            pip install -r requirements.txt
            python main.py
            ```
            
            ### ‚ú® Features
            - üéÆ FPS Boost - Disable unnecessary services and effects
            - ‚ö° Low Latency - Optimize timer resolution, DPC, IRQ
            - üîß GPU Tweaks - NVIDIA, AMD, Intel optimizations
            - üåê Network - TCP/IP optimization, Nagle algorithm
            - üîí Privacy - Disable telemetry and tracking
          draft: false
          prerelease: false
          files: |
            MeoBoost-source.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Deploy GitHub Pages
  pages:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Create landing page
        run: |
          mkdir -p _site
          cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>MeoBoost - Windows Performance Optimizer</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body { 
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
                min-height: 100vh; color: #fff;
                display: flex; align-items: center; justify-content: center;
              }
              .container { text-align: center; padding: 2rem; max-width: 800px; }
              h1 { font-size: 3rem; margin-bottom: 1rem; 
                background: linear-gradient(90deg, #00d4ff, #0096c7);
                -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
              .tagline { font-size: 1.2rem; color: #aaa; margin-bottom: 2rem; }
              .badge { display: inline-block; background: #238636; color: #fff; padding: 0.3rem 0.8rem; 
                border-radius: 20px; font-size: 0.9rem; margin-bottom: 1rem; }
              .cmd { background: #0d1117; border-radius: 8px; padding: 1rem 2rem;
                font-family: 'Consolas', monospace; margin: 2rem 0; border: 1px solid #30363d; }
              .cmd code { color: #58a6ff; }
              .btn { display: inline-block; padding: 1rem 2rem; margin: 0.5rem;
                background: linear-gradient(90deg, #00d4ff, #0096c7); color: #000;
                text-decoration: none; border-radius: 8px; font-weight: bold;
                transition: transform 0.2s; }
              .btn:hover { transform: scale(1.05); }
              .features { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; margin-top: 2rem; }
              .feature { background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px; flex: 1; min-width: 200px; }
              .note { margin-top: 2rem; padding: 1rem; background: rgba(35, 134, 54, 0.2); border-radius: 8px; 
                border: 1px solid #238636; font-size: 0.9rem; }
            </style>
          </head>
          <body>
            <div class="container">
              <span class="badge">‚úÖ Zero AV Detections</span>
              <h1>üê± MeoBoost</h1>
              <p class="tagline">Windows Performance Optimizer for Gaming</p>
              <div class="cmd">
                <code>irm https://raw.githubusercontent.com/Minhboang11-Meo/meoboost/main/run.ps1 | iex</code>
              </div>
              <a href="https://github.com/Minhboang11-Meo/meoboost" class="btn">üì¶ GitHub</a>
              <a href="https://github.com/Minhboang11-Meo/meoboost/releases/latest" class="btn">üìã Releases</a>
              <div class="features">
                <div class="feature">üéÆ FPS Boost</div>
                <div class="feature">‚ö° Low Latency</div>
                <div class="feature">üîí Privacy</div>
                <div class="feature">üîß GPU Tweaks</div>
              </div>
              <div class="note">
                <strong>100% Open Source</strong> - No compiled EXE files. 
                Python is installed automatically. All code is transparent and auditable.
              </div>
            </div>
          </body>
          </html>
          EOF
          # Copy run.ps1 for direct access
          cp run.ps1 _site/run.ps1

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
